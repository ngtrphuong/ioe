{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}User Details - {{ user.username }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-white py-2">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'system_settings' %}">System Settings</a></li>
            <li class="breadcrumb-item"><a href="{% url 'user_list' %}">User Management</a></li>
            <li class="breadcrumb-item active" aria-current="page">User Details</li>
        </ol>
    </nav>
    
    <!-- Page Title -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">User Details - {{ user.username }}</h1>
        <div>
            <a href="{% url 'user_update' user.id %}" class="btn btn-primary">
                <i class="fas fa-edit me-1"></i> Edit User
            </a>
            <a href="{% url 'user_list' %}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-arrow-left me-1"></i> Back to List
            </a>
        </div>
    </div>
    
    <div class="row">
        <!-- User Basic Information -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="rounded-circle bg-light d-inline-flex justify-content-center align-items-center mb-3" style="width: 120px; height: 120px;">
                            <i class="fas fa-user-circle text-primary" style="font-size: 80px;"></i>
                        </div>
                        <h4 class="mb-0">{{ user.get_full_name|default:user.username }}</h4>
                        <p class="text-muted">{{ user.email|default:"Email not set" }}</p>
                        
                        <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %} me-1">
                            {{ user.is_active|yesno:"Active,Inactive" }}
                        </span>
                        {% if user.is_staff %}
                        <span class="badge bg-secondary me-1">Admin Access</span>
                        {% endif %}
                        {% if user.is_superuser %}
                        <span class="badge bg-warning text-dark">Superuser</span>
                        {% endif %}
                    </div>
                    
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            User ID
                            <span class="text-muted">{{ user.id }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Username
                            <span>{{ user.username }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Name
                            <span>{{ user.get_full_name|default:"-" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Email
                            <span>{{ user.email|default:"-" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Last Login
                            <span>{{ user.last_login|date:"Y-m-d H:i"|default:"Never logged in" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Registration Date
                            <span>{{ user.date_joined|date:"Y-m-d H:i"|default:"-" }}</span>
                        </li>
                    </ul>
                </div>
                {% if user.id != request.user.id %}
                <div class="card-footer">
                    <a href="{% url 'user_delete' user.id %}" class="btn btn-danger w-100">
                        <i class="fas fa-trash me-1"></i> Delete This User
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- User Roles and Permissions -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">User Roles</h5>
                </div>
                <div class="card-body">
                    {% if user.groups.exists %}
                    <div class="mb-4">
                        {% for group in user.groups.all %}
                        <div class="card mb-3 border-0 bg-light">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <i class="fas {% if group.name == 'Salesperson' %}fa-user-tag{% elif group.name == 'Warehouse Manager' %}fa-warehouse{% elif group.name == 'Financial Staff' %}fa-file-invoice-dollar{% elif group.name == 'Administrator' %}fa-user-shield{% else %}fa-users{% endif %} me-2"></i>
                                    {{ group.name }}
                                </h5>
                                <p class="card-text text-muted small">
                                    {% if group.name == 'Salesperson' %}
                                    Responsible for sales and member management, can create sales records and manage member information.
                                    {% elif group.name == 'Warehouse Manager' %}
                                    Responsible for inventory and product management, can add products and adjust inventory.
                                    {% elif group.name == 'Financial Staff' %}
                                    Responsible for viewing financial data and report analysis, can view sales and inventory data.
                                    {% elif group.name == 'Administrator' %}
                                    Has administrative permissions for most system functions, can manage users and system settings.
                                    {% else %}
                                    Has the permissions set for this user group.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i> This user has no roles assigned
                    </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'user_update' user.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-user-cog me-1"></i> Manage User Roles and Permissions
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Operation Records -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Recent Operation Records</h5>
                </div>
                <div class="card-body">
                    {% if logs %}
                    <div class="timeline">
                        {% for log in logs %}
                        <div class="timeline-item">
                            <div class="timeline-marker 
                                {% if log.operation_type == 'ADD' %}bg-success{% elif log.operation_type == 'CHANGE' %}bg-primary{% elif log.operation_type == 'DELETE' %}bg-danger{% else %}bg-secondary{% endif %}">
                                <i class="fas 
                                    {% if log.operation_type == 'ADD' %}fa-plus{% elif log.operation_type == 'CHANGE' %}fa-edit{% elif log.operation_type == 'DELETE' %}fa-trash{% else %}fa-info{% endif %}">
                                </i>
                            </div>
                            <div class="timeline-content">
                                <div class="mb-1">
                                    <strong>{{ log.details }}</strong>
                                </div>
                                <div class="text-muted small">
                                    {{ log.timestamp|date:"Y-m-d H:i:s" }}
                                    {% if log.ip_address %}
                                    <span class="ms-2">IP: {{ log.ip_address }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i> No operation records found
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-left: 2px solid #e9ecef;
        padding-left: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -10px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        color: white;
        font-size: 0.7rem;
    }
</style>
{% endblock %} 