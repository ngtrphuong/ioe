{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Member Details - {{ member.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Member Details</h1>
                <div>
                    <a href="{% url 'member_edit' pk=member.id %}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> Edit Member
                    </a>
                    <a href="{% url 'member_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            <!-- Member Basic Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Member Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>Member Name:</strong> {{ member.name }}</p>
                            <p><strong>Member ID:</strong> {{ member.member_id }}</p>
                            <p><strong>Contact Phone:</strong> {{ member.phone }}</p>
                            <p><strong>Email:</strong> {{ member.email|default:"Not Set" }}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Member Level:</strong> <span class="badge bg-{{ member.level.color|default:'primary' }}">{{ member.level.name }}</span></p>
                            <p><strong>Current Points:</strong> <span class="badge bg-success">{{ member.points }}</span></p>
                            <p><strong>Account Balance:</strong> <span class="badge bg-info">{{ member.balance }}</span></p>
                            <p><strong>Status:</strong> {% if member.is_active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-danger">Inactive</span>{% endif %}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Birthday:</strong> {{ member.birthday|date:"Y-m-d"|default:"Not Set" }}</p>
                            <p><strong>Gender:</strong> {{ member.get_gender_display|default:"Not Set" }}</p>
                            <p><strong>Address:</strong> {{ member.address|default:"Not Set" }}</p>
                            <p><strong>Registration Date:</strong> {{ member.created_at|date:"Y-m-d H:i" }}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Total Spent:</strong> {{ total_spent|floatformat:2 }}</p>
                            <p><strong>Purchase Count:</strong> {{ visit_count }}</p>
                            <p><strong>Last 30 Days Spent:</strong> {{ recent_spent|floatformat:2 }}</p>
                            <p><strong>Last 30 Days Visits:</strong> {{ recent_visit_count }}</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="btn-group">
                        <a href="{% url 'member_recharge' pk=member.id %}" class="btn btn-success">
                            <i class="bi bi-wallet2"></i> Account Recharge
                        </a>
                        <a href="{% url 'member_balance_adjust' pk=member.id %}" class="btn btn-warning">
                            <i class="bi bi-currency-exchange"></i> Adjust Balance
                        </a>
                        <a href="{% url 'member_points_adjust' pk=member.id %}" class="btn btn-info">
                            <i class="bi bi-star"></i> Adjust Points
                        </a>
                        <a href="{% url 'member_recharge_records' pk=member.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-clock-history"></i> Recharge Records
                        </a>
                    </div>
                </div>
            </div>

            <!-- Account Transaction Records -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Account Transaction Records</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Transaction Time</th>
                                    <th>Transaction Type</th>
                                    <th>Balance Change</th>
                                    <th>Points Change</th>
                                    <th>Description</th>
                                    <th>Operator</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ transaction.get_transaction_type_display }}</td>
                                    <td class="{% if transaction.balance_change > 0 %}text-success{% elif transaction.balance_change < 0 %}text-danger{% endif %}">
                                        {% if transaction.balance_change != 0 %}
                                            {{ transaction.balance_change|floatformat:2 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="{% if transaction.points_change > 0 %}text-success{% elif transaction.points_change < 0 %}text-danger{% endif %}">
                                        {% if transaction.points_change != 0 %}
                                            {{ transaction.points_change }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ transaction.description }}</td>
                                    <td>{{ transaction.created_by.username }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No transaction records available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Purchase Records -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Purchase Records</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order Number</th>
                                    <th>Purchase Date</th>
                                    <th>Item Quantity</th>
                                    <th>Order Amount</th>
                                    <th>Amount Paid</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in sales %}
                                <tr>
                                    <td>{{ sale.sale_number }}</td>
                                    <td>{{ sale.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ sale.items.count }}</td>
                                    <td>{{ sale.total_amount|floatformat:2 }}</td>
                                    <td>{{ sale.final_amount|floatformat:2 }}</td>
                                    <td>{{ sale.get_payment_method_display }}</td>
                                    <td>
                                        <a href="{% url 'sale_detail' sale_id=sale.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No purchase records available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}