{% extends 'inventory/base.html' %}

{% block title %}Member Purchase Records - {{ block.super }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <h2 class="card-title mb-0">Member Purchase Records Query</h2>
                        <p class="text-muted mb-md-0">Query purchase records by member phone number or name</p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{% url 'member_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-people me-1"></i> Member Management
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" action="{% url 'member_purchases' %}" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                                <input type="text" name="search" class="form-control" value="{{ search_term }}" placeholder="Enter member phone number or name..." required>
                                <button type="submit" class="btn btn-primary">Query</button>
                            </div>
                        </div>
                    </div>
                </form>
                
                {% if search_term %}
                    {% if member %}
                        <div class="alert alert-info mb-4">
                            <div class="d-flex align-items-center">
                                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; font-weight: 500;">
                                    {{ member.name|slice:"0:1"|default:"-" }}
                                </div>
                                <div>
                                    <h5 class="mb-1">{{ member.name }}</h5>
                                    <p class="mb-0">Phone: {{ member.phone }} | Member Level: {{ member.level.name }} | Purchase Count: {{ member.purchase_count }} | Total Spend: 짜{{ member.total_spend }}</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if sales %}
                            <h5 class="mb-3">Purchase Records (Total: {{ sales|length }})</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order Number</th>
                                            <th>Purchase Date</th>
                                            <th>Purchase Amount</th>
                                            <th>Discount Amount</th>
                                            <th>Amount Paid</th>
                                            <th>Points Earned</th>
                                            <th>Salesperson</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for sale in sales %}
                                        <tr>
                                            <td>
                                                <a href="#" class="fw-bold text-primary">#{{ sale.id }}</a>
                                            </td>
                                            <td>{{ sale.created_at|date:"Y-m-d H:i" }}</td>
                                            <td>짜{{ sale.total_amount|floatformat:2 }}</td>
                                            <td>짜{{ sale.discount_amount|floatformat:2 }}</td>
                                            <td class="fw-bold text-success">짜{{ sale.final_amount|floatformat:2 }}</td>
                                            <td>{{ sale.points_earned }}</td>
                                            <td>{{ sale.operator.username }}</td>
                                            <td>{{ sale.notes|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i> This member has no purchase records yet
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i> No member found with phone number or name "{{ search_term }}"
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 